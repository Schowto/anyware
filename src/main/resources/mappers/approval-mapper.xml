<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd" >
<mapper namespace="approvalMapper">
  
	<resultMap id="approvalResult" type="Approval">
		<id column="appro_no" property="approNo"/>
			<result column="writer_name" property="writerName"/>
			<result column="writer_job" property="writerJob"/>
			<result column="tpl_title" property="tplTitle"/>
			<result column="appro_title" property="approTitle"/>
			<result column="appro_content" property="approContent"/>
			<result column="inter_no" property="interNo"/>
			<result column="inter_name" property="interName"/>
			<result column="inter_job" property="interJob"/>
			<result column="inter_appro" property="interAppro"/>
			<result column="final_no" property="finalNo"/>
			<result column="final_name" property="finalName"/>
			<result column="final_job" property="finalJob"/>
			<result column="final_appro" property="finalAppro"/>
			<result column="create_date" property="createDate"/>
		 <!-- 	
		<collection property="refNo" ofType="Integer">
			<result column="refMem_No"/>
		</collection>
		
		<collection property="openNo" ofType="Integer">
			<result column="openMem_no"/>
		</collection>
		 -->
	</resultMap>
	
	<!-- ==================================================================== -->

	<sql id="ingCount">
		select count(*)
		  from tb_approval
		 where status = 'Y'
	   and not inter_appro = '반려'  
		   and final_appro = '대기'
	</sql>
	
	<sql id="endCount">
		select count(*)
		  from tb_approval
		 where status = 'Y'
	       and (
       				inter_appro = '반려' 
       		     or final_appro in ('결재', '반려')
       		     or (
       		     	     inter_appro = '결재'
       		     	 and final_appro = '결재'	
       		     	)
       		    )
	</sql>
	
	<select id="ingCountAll" resultType="_int">
		<include refid="ingCount"/>
		and(
				member_no = #{userNo}
			 or (
					inter_appro = '대기' 
	       		and inter_no = #{userNo} 
	        	 or inter_appro = '결재'	
				and final_no = #{userNo}
				)
			or  (
					    inter_appro = '대기' 
				    and final_no = #{userNo}	
			)			
		)
	</select>
	
	<select id="ingCountContinue" resultType="_int">
		<include refid="ingCount"/>
		and member_no = #{userNo}
	</select>
	
	<select id="ingCountWait" resultType="_int">
		<include refid="ingCount"/>
		and (
				inter_appro = '대기' 
       		and inter_no = #{userNo} 
        	 or inter_appro = '결재'	
			and final_no = #{userNo}
			)
	</select>
	
	<select id="ingCountExpected" resultType="_int">
		<include refid="ingCount"/>
		 and inter_appro = '대기' 
		 and final_no = #{userNo}	
	</select>
	
	<select id="ingCountRef" resultType="_int">
		<include refid="ingCount"/>
	</select>
	
	<select id="endCountAll" resultType="_int">
		<include refid="endCount"/>
	</select>
	
	<select id="endCountSuggest" resultType="_int">
		<include refid="endCount"/>
		and member_no = #{userNo}
	</select>
	
	<select id="endCountConfirm" resultType="_int">
		<include refid="endCount"/>
	</select>
	
	<select id="endCountOpen" resultType="_int">
		<include refid="endCount"/>
	</select>
	
	<!-- ========================================================================== -->
	
	<sql id="ingList">
			select appro_no
			     , m.name as writer_name
	             , m.job_name as writer_job
                 , i.name as inter_name
	             , a.inter_appro
                 , f.name as final_name
	             , a.final_appro
	             , t.tpl_title 
	             , appro_title
	             , create_date
	 	      from tb_approval a
		     inner join tb_member m on ( a.member_no = m.member_no)
	         inner join tb_member i on ( a.inter_no = i.member_no)
	         inner join tb_member f on ( a.final_no = f.member_no)
		     inner join tb_app_tpl t on ( a.tpl_no = t.tpl_no)
		     where a.status = 'Y' 
		   and not inter_appro = '반려'  
		       and final_appro = '대기'
	</sql>
	
	<sql id="endList">
			select appro_no
			     , m.name as writer_name
	             , m.job_name as writer_job
                 , i.name as inter_name
	             , a.inter_appro
                 , f.name as final_name
	             , a.final_appro
	             , t.tpl_title 
	             , appro_title
	             , create_date
	 	      from tb_approval a
		     inner join tb_member m on ( a.member_no = m.member_no)
	         inner join tb_member i on ( a.inter_no = i.member_no)
	         inner join tb_member f on ( a.final_no = f.member_no)
		     inner join tb_app_tpl t on ( a.tpl_no = t.tpl_no)
		      where a.status = 'Y'
	       and (
       				inter_appro = '반려' 
       		     or final_appro in ('결재', '반려')
       		     or (
       		     	     inter_appro = '결재'
       		     	 and final_appro = '결재'	
       		     	)
       		    )
	</sql>
	
	<select id="ingListAll" resultMap="approvalResult">
		<include refid="ingList"/>
		<!-- 자신이 기안한 결재가 가장 상위로 오도록 -->
		and(
				a.member_no = #{userNo}
				
			 or (
					inter_appro = '대기' 
	       		and inter_no = #{userNo} 
	        	 or inter_appro = '결재'	
				and final_no = #{userNo}
				)
				
			or  (
					    inter_appro = '대기' 
				    and final_no = #{userNo}	
				)			
		)
		order
		    by (case when a.member_no = #{userNo} then 1 else 2 end)
	</select>
	
	<select id="ingListContinue" resultMap="approvalResult">
		<include refid="ingList"/>
		and a.member_no = #{userNo}	
	</select>
		
	<select id="ingListWait" resultMap="approvalResult">
		<include refid="ingList"/>
		and (
				inter_appro = '대기' 
       		and inter_no = #{userNo} 
        	 or inter_appro = '결재'	
			and final_no = #{userNo}
			)
	</select>
		
	<select id="ingListExpected" resultMap="approvalResult">
		<include refid="ingList"/>
		 and inter_appro = '대기' 
		 and final_no = #{userNo}
	</select>
		
	<select id="ingListRef" resultMap="approvalResult">
		<include refid="ingList"/>
	</select>
		
	<select id="endListAll" resultMap="approvalResult">
		<include refid="endList"/>
		order
	    by (case when a.member_no = #{userNo} then 1 else 2 end)
	</select>
		
	<select id="endListSuggest" resultMap="approvalResult">
		<include refid="endList"/>
		and a.member_no = #{userNo}	
	</select>
		
	<select id="endListConfirm" resultMap="approvalResult">
		<include refid="endList"/>
	</select>
		
	<select id="endListOpen" resultMap="approvalResult">
		<include refid="endList"/>
	</select>
		
		
		
<!-- ========================================================================================= -->		
		
	<select id="selectAppro1" resultMap="approvalResult">
				select appro_no
			     , m.name as writer_name
	             , m.job_name as writer_job
                 , i.name as inter_name
                 , i.job_name as inter_job
                 , f.name as final_name
                 , f.job_name as final_job
	             , t.tpl_title 
	             , appro_title
	             , create_date
	     from tb_approval a
	     inner join tb_member m on ( a.member_no = m.member_no)
         inner join tb_member i on ( a.inter_no = i.member_no)
         inner join tb_member f on ( a.final_no = f.member_no)
	     inner join tb_app_tpl t on ( a.tpl_no = t.tpl_no)
	    where a.status = 'Y' 
	      and a.member_no = #{userNo}
	</select>	
 	
 
 	<select id="selectAppro2" resultMap="approvalResult">
		select appro_no
	    	 , a.member_no 
             , appro_title
             , appro_content
             , inter_no
             , i.name "중간결재자"
             , inter_appro
             , final_no
             , final_appro
             , create_date
	      from tb_approval a
	     inner join tb_member m on ( a.member_no = m.member_no)
	     inner join tb_member i on (a.inter_no = i.member_no)
	     where a.status = 'Y' 
 	</select>
  
   
   
</mapper>
